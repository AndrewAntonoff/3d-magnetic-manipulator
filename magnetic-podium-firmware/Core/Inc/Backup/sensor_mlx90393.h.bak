#ifndef __SENSOR_MLX90393_H
#define __SENSOR_MLX90393_H

#include "main.h"
#include "config.h"

// Структура датчика MLX90393
typedef struct {
    // Аппаратная конфигурация
    SPI_HandleTypeDef* spi;
    GPIO_TypeDef* cs_port;
    uint16_t cs_pin;
    uint8_t i2c_address;  // Для совместимости

    // Данные
    float magnetic_field[3];    // X, Y, Z в мТл
    float temperature;          // Температура в °C
    uint32_t last_read_time;

    // Калибровка
    float offset[3];
    float scale[3];
    float rotation_matrix[3][3];

    // Состояние
    uint8_t is_connected;
    uint8_t is_calibrated;
    uint8_t read_error_count;
    uint8_t config_registers[8];

    // Статистика
    uint32_t total_reads;
    uint32_t failed_reads;
    float average_read_time_ms;
} MLX90393_t;

// Структура для 3D позиции
typedef struct {
    float x;  // мм
    float y;  // мм
    float z;  // мм
    float confidence;  // 0.0 - 1.0
    uint32_t timestamp;
} Position3D_t;

// Прототипы функций
void Sensors_Init(void);
void Sensors_Deinit(void);
uint8_t Read_Sensor(uint8_t sensor_idx);
uint8_t Read_All_Sensors(void);

// Калибровка
void Calibrate_Sensors_Start(void);
void Calibrate_Sensors_Stop(void);
uint8_t Is_Calibration_Running(void);
void Save_Calibration_To_Flash(void);
void Load_Calibration_From_Flash(void);

// Обработка данных
void Calculate_Ball_Position(Position3D_t* position);
void Apply_Calibration(uint8_t sensor_idx);
float Calculate_Magnetic_Field_Strength(uint8_t sensor_idx);

// Диагностика
uint8_t Test_Sensor_Connection(uint8_t sensor_idx);
void Run_Sensor_Self_Test(uint8_t sensor_idx);
uint8_t Get_Sensor_Health_Status(uint8_t sensor_idx);

// Мониторинг
void Get_Sensor_Data_String(char* buffer, uint16_t buffer_size);
void Get_Sensor_Stats_String(char* buffer, uint16_t buffer_size);
float Get_Sensor_Read_Frequency(uint8_t sensor_idx);

// Расширенная диагностика SPI
void Test_SPI_Bus(uint8_t test_pattern);
uint8_t Verify_SPI_Communication(void);
void Measure_SPI_Timing(void);

#endif /* __SENSOR_MLX90393_H */
